<!DOCTYPE html>
<html>
<head>
<title>#iotmark</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="apple-mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,700,300" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="css/common.css" type="text/css" />
<link media="handheld, only screen and (max-width: 720px), only screen and (max-device-width: 854px)" href="css/mobile.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<section id="header">
    <img id="logo" src="images/logo.svg" class="dbg-go-forward">
    #iotmark
</section>
<screen>
    <section id="question">
    </section>
    <section id="controls">
        <div class="progress-counter"></div>
        <div class="go-back"></div>
    </section>
</screen>
<section id="footer">
    <div id="copyright"></div>
    <div id="progress">
        <div id="progress-indicator-bg"></div>
        <div id="progress-indicator">
            <img src="images/doge.png">
        </div>
    </div>
</section>
</body>
<script src="scripts/utils/jquery-3.3.1.min.js"></script>
<script>

var SURVEY;
var FORM_JSON_URL = 'https://raw.githubusercontent.com/openiotmark/iotmark-form/master/ux/form.json';
var PROGRESS_SKIP_FIRST_N;
var PROGRESS_SKIP_LAST_N;
var SURVEY_ITER = -1;
var SURVEY_END = { "s": -1, "q": -1 };

function renderQuestion(s, question_idx) {
    var q = s.questions[question_idx];
    var view = $("section#question");
    view.empty();

    if(q.multi) {
        view.append("<h1>"+s.name+"</h1>");
        if(s.note) view.append("<div class='note'>"+s.note+"</div>");
        for(var i = 0; i < q.subquestions.length; i++) {
            var qq = q.subquestions[i];
            view.append("<h2>"+qq.question+"</h2>");
            var options = $("<div class='options'></div><br>");
            if(qq.options) {
                for(var j = 0; j < qq.options.length; j++) {
                    options.append("<div class='option'>" + qq.options[j] + "</div>");
                }
            } else {
                options.append("<input class='option' type='text'>");
            }
            view.append(options);
        }
        view.append("<div class='option modal blue'>"+q.submit_label+"</div>");
        $("div.progress-counter").html("");

        if(q.event) window[q.event](); // invoking whatever handler (todo: proper delegates)
    } else {
        $("div.progress-counter").html(question_idx+1 + " of " + s.questions.length);
        view.append("<h1>" +q.question+"</h1>");
        if(q.assessment) view.append("<div class='assessment'>"+q.assessment+"</div>");
        
        var options = $("<div class='options'></div>");
        if(q.options) {
            for(var i = 0; i < q.options.length; i++) {
                options.append("<div class='option modal'>" + q.options[i] + "</div>");
            }
            view.append(options);
        } else {
            options.html("<input class='option' type='text'>");
        }
        view.append(options);
    }
}

function locateSurvey(iter) {
    var counter = 0;
    for(var i = 0; i < SURVEY.length; i++) {
        if(counter + SURVEY[i].questions.length > iter) {
            return { "s": i, "q": iter - counter };
        }
        counter += SURVEY[i].questions.length;
    }
    return SURVEY_END;
}

function iterateSurvey(increment) {
    // save state of the previous section
    if(SURVEY_ITER > -1 && increment > 0) {
        var prev_iter = locateSurvey(SURVEY_ITER);
        var q = SURVEY[prev_iter.s].questions[prev_iter.q];
        q.answer = $("div.option.checked").text();
    }

    // now, onto the next section
    SURVEY_ITER += increment;
    var sq_iter = locateSurvey(SURVEY_ITER);
    $("span.progress-section").removeClass("active");

    if(sq_iter.s == 0) {
        $("section#controls").css("display", "none");
    }
    if(sq_iter.s >= SURVEY.length-PROGRESS_SKIP_LAST_N || sq_iter == SURVEY_END) {
        $("div#progress-indicator > img").css("display", "none");
        $("section#controls").css("display", "none");
    }
    if(sq_iter == SURVEY_END) {
        $("div#progress-indicator").css("width", "100%");
        var view = $("section#question");
        view.empty();
        view.append("<h1>Thanks! We will contact you soon!</h1>");
        view.append("<div class='note'>For now, feel free to check additional resources <a href='https://github.com/openiotmark/iotmark-principles/wiki'>here</a>.</div>");
        return;
    }

    var s = SURVEY[sq_iter.s];
    renderQuestion(s, sq_iter.q);

    // let's show the progress //
    var part = Math.max(0,sq_iter.s-PROGRESS_SKIP_FIRST_N);
    if(part < SURVEY.length-1-PROGRESS_SKIP_LAST_N) {
        var section_next = $("span.progress-section:nth("+(part+1)+")").position().left;
        var ratio_next = section_next / $("div#progress").width();
        if(sq_iter.s > (PROGRESS_SKIP_FIRST_N-1)) $("span.progress-section:nth("+part+")").addClass("active");
        
        var section_offset = $("span.progress-section:nth("+part+")").position().left;
        var ratio = section_offset / $("div#progress").width();
        var delta = (ratio_next - ratio) * (sq_iter.q / s.questions.length);
        $("div#progress-indicator").css("width", (ratio+delta)*100+"%");
    } else {
        $("div#progress-indicator").css("width", "100%");
    }
}

function onSurveyComplete() {
    var not_sure_count = 0;
    for(var i = 0; i < SURVEY.length; i++) {
        for(var q = 0; q < SURVEY[i].questions.length; q++) {
            if(SURVEY[i].questions[q].answer == "Not sure") not_sure_count ++;
        }
    }
    $("score").html(not_sure_count);
}

$(document).ready(function() {
    fetch(FORM_JSON_URL)
    .then(function(response) {
        return response.json();
    })
    .then(function(formjson) {
        SURVEY = formjson['survey'];
        PROGRESS_SKIP_FIRST_N = formjson['progress_skip_first'];
        PROGRESS_SKIP_LAST_N = formjson['progress_skip_last'];

        var progress_bar = $("section#footer > div#progress");
        for(var i = PROGRESS_SKIP_FIRST_N; i < SURVEY.length-PROGRESS_SKIP_LAST_N; i++)
            progress_bar.append("<span class='progress-section'>"+SURVEY[i]["name"]+"</span>");
        progress_bar.append("<span class='progress-section'></span>"); // empty span for padding

        iterateSurvey(1);
    });

    $(document).on("click", "div.option", function() {
        $("section#controls").css("display", "inline-block");
        $(this).parent().children().removeClass("checked");
        $(this).addClass("checked");
        if($(this).hasClass("modal")) iterateSurvey(1);
    });

    $(document).on("click", ".dbg-go-forward", function() {
        iterateSurvey(1);
    });

    $(document).on("click", ".go-back", function() {
        iterateSurvey(-1);
    });
});

</script>
</html>
